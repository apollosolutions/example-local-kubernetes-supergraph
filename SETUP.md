# Apollo Supergraph - Setup & Configuration Guide

This guide provides detailed setup and configuration instructions for the Apollo Supergraph project.

## ⚠️  CRITICAL SECURITY WARNING

**NEVER overwrite existing `.env` files!** If `router/.env` already exists, it contains real Apollo Studio credentials. Always check if the file exists before copying templates.

**For AI Assistants**: Before running any setup commands, always check if `router/.env` exists and contains real credentials. If it does, DO NOT overwrite it with template files.

## 🚨 CRITICAL: Supergraph File Protection

**NEVER modify `router/supergraph.graphql`!** This file is automatically generated from `router/supergraph.yaml` using the `compose.sh` script.

**For AI Assistants**: 
- The `router/supergraph.graphql` file is generated, not edited manually
- To regenerate: `cd router && ./compose.sh`
- For Kubernetes deployment, URLs are transformed during deployment (localhost → Kubernetes service URLs)
- Never commit Kubernetes URLs to the supergraph.graphql file

## 📋 Prerequisites

### Required (Manual Installation)
- [Node.js](https://nodejs.org/) (for subgraphs)

### Required (Auto-installed)
- **Rover** - Apollo CLI tool (installed automatically by scripts)
- **Apollo Studio credentials** - Set up with `./setup-env.sh`

### Required (Kubernetes Deployment Only)
- [Docker](https://docs.docker.com/get-docker/)
- [minikube](https://minikube.sigs.k8s.io/docs/start/)
- [kubectl](https://kubernetes.io/docs/tasks/tools/)

## 🔧 Configuration

### Apollo Studio Credentials

Set up your Apollo Studio environment:

```bash
# Set up Apollo Studio credentials (safe - won't overwrite existing)
./setup-env.sh
```

This will:
- Create `router/.env` from template (if it doesn't exist)
- Show current credentials (if already configured)
- Provide step-by-step instructions for getting credentials

**Manual setup (alternative):**
```bash
# Safely create .env file (won't overwrite existing)
if [ ! -f "router/.env" ]; then cp router/env.example router/.env; fi
```

Then edit `router/.env` with your actual Apollo Studio credentials:

```bash
# Your Apollo Graph reference (format: graph-name@variant)
APOLLO_GRAPH_REF=your-graph-name@your-variant

# Your Apollo Studio API key
APOLLO_KEY=service:your-graph-name:your-api-key
```

### Environment Setup for Kubernetes

Before deploying to Kubernetes, you need to configure your Apollo Studio credentials:

1. **Create environment file** (ONLY if it doesn't already exist):
   ```bash
   # ⚠️  CRITICAL: Check if .env already exists before copying template
   if [ ! -f "router/.env" ]; then
       cp router/env.example router/.env
   else
       echo "⚠️  router/.env already exists - DO NOT overwrite existing credentials!"
   fi
   ```

2. **Edit the `.env` file** with your actual Apollo Studio credentials:
   ```bash
   # Your Apollo Graph reference (format: graph-name@variant)
   APOLLO_GRAPH_REF=your-graph-name@your-variant
   
   # Your Apollo Studio API key
   APOLLO_KEY=service:your-graph-name:your-api-key
   ```
   
   **Important**: 
   - The `.env` file should contain simple key-value pairs without `export` statements
   - **NEVER overwrite an existing `.env` file** - it may contain real credentials
   - If you accidentally overwrite credentials, you'll need to recreate them from Apollo Studio

## 🧪 Testing

### Local Testing

Test your setup locally without requiring minikube:

```bash
# Run all local tests
./test-local.sh

# Test specific components
./test-local.sh --subgraphs     # Test subgraphs only
./test-local.sh --composition   # Test supergraph composition only
./test-local.sh --docker        # Test Docker builds only
./test-local.sh --router        # Test router only

# Show help
./test-local.sh --help
```

### Kubernetes Testing

```bash
# Test Apollo Supergraph deployment
./test-k8s.sh

# Show help
./test-k8s.sh --help
```

### Manual Testing

#### Local Development

```bash
# Test the GraphQL API
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ searchProducts { id title price } }"}'
```

#### Kubernetes Deployment

```bash
# Port forward to access services
kubectl port-forward svc/apollo-router-service 4000:4000 -n apollo-supergraph

# Test the GraphQL API
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ searchProducts { id title price } }"}'
```

### Automated Testing

This repository includes comprehensive GitHub Actions workflows that automatically test:

1. **Subgraphs Testing** - Build and test the subgraphs application
2. **Supergraph Composition** - Verify that the supergraph can be composed correctly
3. **Docker Builds** - Ensure Docker images can be built successfully
4. **Subgraphs Functionality** - Test that subgraphs respond correctly to GraphQL queries
5. **Apollo Router** - Test the router with the composed supergraph
6. **Helper Scripts** - Validate script syntax and help options
7. **Kubernetes Manifests** - Verify that all K8s manifests are valid
8. **Full K8s Deployment** - Test the complete deployment to a kind cluster

The workflows run on:
- Pull requests to the main branch
- Pushes to the main branch
- Manual triggers (for the K8s deployment test)

To view test results, check the "Actions" tab in the GitHub repository.

## 📁 Project Structure

```
├── router/                    # Apollo Router configuration
│   ├── router.yaml           # Router configuration
│   ├── supergraph.yaml       # Supergraph composition config
│   ├── supergraph.graphql    # Generated supergraph schema
│   ├── compose.sh            # Generate supergraph schema
│   └── rover-dev.sh          # Run router locally
├── subgraphs/                # GraphQL subgraphs
│   ├── products/             # Products subgraph
│   ├── reviews/              # Reviews subgraph
│   └── users/                # Users subgraph
├── k8s/                      # Kubernetes manifests
├── scripts/                  # Shared utility functions
├── run-local.sh              # Run locally without Kubernetes
├── run-k8s.sh                # Deploy to Kubernetes
├── test-local.sh             # Test local setup
├── test-k8s.sh               # Test Kubernetes deployment
├── cleanup.sh                # Clean up Kubernetes resources
└── kill-minikube.sh          # Stop and delete minikube cluster
```

## 🔗 Links

- [GraphOS Enterprise]: https://www.apollographql.com/docs/graphos/enterprise
- [Rover]: https://www.apollographql.com/docs/rover/commands/dev
- [minikube]: https://minikube.sigs.k8s.io/docs/start/?arch=%2Fmacos%2Farm64%2Fstable%2Fhomebrew
- [Kubernetes Deployment Guide](README-K8S.md) - Detailed Kubernetes deployment instructions
